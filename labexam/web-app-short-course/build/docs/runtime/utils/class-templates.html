<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Class Templates</title>
<!-- 2017-04-26 Wed 22:27 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="VLEAD" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../style/css/worg-style.css" />
<link rel="stylesheet" type="text/css" href="../../style/css/override.css" />
<link rel="icon" type="image/png" href="../../style/img/favicon/popl.png" />
<script type="text/javascript" src="../../style/js/org-info.js">
/**
 *
 * @source: ../../style/js/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in ../../style/js/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in ../../style/js/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "1");
org_html_manager.set("LINK_HOME", "../../index.html");
org_html_manager.set("LINK_UP", "../index.html");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../index.html"> UP </a>
 |
 <a accesskey="H" href="../../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Class Templates</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Introduction</a></li>
<li><a href="#sec-2">2. Creating classes on the fly</a>
<ul>
<li><a href="#sec-2-1">2.1. Test cases</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Value Classes</a>
<ul>
<li><a href="#sec-3-1">3.1. Definition</a></li>
<li><a href="#sec-3-2">3.2. Test cases</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Class template</a>
<ul>
<li><a href="#sec-4-1">4.1. Implementation</a>
<ul>
<li><a href="#sec-4-1-1">4.1.1. The getter function</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-5">5. Tests</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This module introduces metaprogramming techniques for
building  classes and populating them.
</p>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Creating classes on the fly</h2>
<div class="outline-text-2" id="text-2">
<p>
See <a href="http://stackoverflow.com/questions/2461751/python-class-factory-using-user-input-as-class-names">this discussion</a> on Stack Overflow about how to create
classes on the fly:
</p>

<div class="org-src-container">

<pre class="src src-python" id="def_meta"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">meta</span>(_name):
    <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">cls</span>():
        <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">inv</span>(args):
            <span style="font-weight: bold;">pass</span>

    cls.<span style="font-weight: bold;">__name__</span> = _name
    <span style="font-weight: bold;">return</span> cls
</pre>
</div>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Test cases</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-python" id="class_TestMeta"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestMeta</span>(TestCase):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">test_meta</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold; font-style: italic;">Bar</span> = meta(<span style="font-style: italic;">"Bar"</span>)
        <span style="font-weight: bold; font-style: italic;">bar</span> = Bar()
        <span style="font-weight: bold;">self</span>.assertTrue(<span style="font-weight: bold;">isinstance</span>(bar, Bar))
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Value Classes</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Definition</h3>
<div class="outline-text-3" id="text-3-1">
<p>
A <i>value</i> class of type <code>p</code> is a class that holds one state
variable, called <code>value</code> that is guaranteed to satisfy =p.
</p>

<p>
A value class has the following methods: <code>__init__</code>,
<code>__eq__</code>, <code>__str__</code>, <code>get_value</code> and <code>set_value</code>.  
</p>

<p>
The class <code>ValueClassTemplate</code> defines static methods that
populate a value class with the above standard methods.
Note the type checks on the <code>__init__</code> and <code>set_value</code>
methods. 
</p>

<div class="org-src-container">

<pre class="src src-python" id="class_ValueClassTemplate"><span style="font-weight: bold;">from</span> runtime.utils.type_utils <span style="font-weight: bold;">import</span> *
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ValueClassTemplate</span>():

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_init</span>(type_pred):
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(obj, val):
            <span style="font-weight: bold; font-style: italic;">obj.value</span> = check_pred(type_pred)(val)
        <span style="font-weight: bold;">return</span> fn

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_get</span>():
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(obj):
            <span style="font-weight: bold;">return</span> obj.value
        <span style="font-weight: bold;">return</span> fn

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_eq</span>():
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(obj, other) :
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">isinstance</span>(other, obj.__class__):
                <span style="font-weight: bold;">return</span> obj.value == other.value
            <span style="font-weight: bold;">else</span>:
                <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">False</span>
        <span style="font-weight: bold;">return</span> fn

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_str</span>():
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(obj):
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">str</span>(obj.value)
        <span style="font-weight: bold;">return</span> fn

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_class</span>(_name, type_pred):
        <span style="font-weight: bold; font-style: italic;">cls</span> = meta(_name) 
        <span style="font-weight: bold; font-style: italic;">cls.__init__</span> = ValueClassTemplate.mk_init(type_pred)
        <span style="font-weight: bold; font-style: italic;">cls.get</span> = ValueClassTemplate.mk_get()
        cls.<span style="font-weight: bold;">set</span> = ValueClassTemplate.mk_init(type_pred)
        <span style="font-weight: bold; font-style: italic;">cls.__eq__</span>   = ValueClassTemplate.mk_eq()
        <span style="font-weight: bold; font-style: italic;">cls.__str__</span>  = ValueClassTemplate.mk_str()
        <span style="font-weight: bold;">return</span> cls
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Test cases</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">

<pre class="src src-python" id="class_TestValueClassTemplate"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestValueClassTemplate</span>(TestCase):

    <span style="font-weight: bold; font-style: italic;">Name</span> = ValueClassTemplate.mk_class(<span style="font-style: italic;">"Name"</span>, is_alphabetic_str)
    <span style="font-weight: bold; font-style: italic;">Name.n1</span> = Name(<span style="font-style: italic;">"ravi"</span>)
    <span style="font-weight: bold; font-style: italic;">Name.n2</span> = Name(<span style="font-style: italic;">"Ravi"</span>)

        
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">test_value_class_template</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold; font-style: italic;">Name</span> = TestValueClassTemplate.Name
        <span style="font-weight: bold;">print</span> <span style="font-style: italic;">"test_value_class_template"</span>
        <span style="font-weight: bold;">self</span>.assertEqual(Name.n1.get(), <span style="font-style: italic;">"ravi"</span>, <span style="font-style: italic;">"n1.get()"</span>)
        Name.n1.<span style="font-weight: bold;">set</span>(<span style="font-style: italic;">"Ravi"</span>)
        <span style="font-weight: bold;">self</span>.assertTrue(Name.n1.get()==Name.n2.get(), <span style="font-style: italic;">"n1.get()==n2.get()"</span>)
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Class template</h2>
<div class="outline-text-2" id="text-4">
<p>
This is a template for making classes.  The class template
is useful for creating data classes, i.e., classes whose
objects have state variables that are typed and that have an
invariant holding them together.  These data classes come
with a standard set of setters and getters.  Equality
predicate may be added later (see <code>Temp</code> example below)
</p>


<p>
Class templates take a 
</p>
<ul class="org-ul">
<li>the name of the class to be created (string)
</li>

<li>A specification of the names of the state variables and
their types (dictionary)
</li>

<li>An invariant which is a function of an instance of the
class and a dictionary of the state variables.  The
invariant is optional, but if present is part of the same
dictionary that specifies the state variables, against
the key <code>inv</code>. 
</li>
</ul>

<pre class="example">
   Temp = ClassTemplate.mk_class("Temp", min=is_int, max=is_int, 
                                 inv=lambda self, args: 
								      args["min"] &lt;= args["max"])

   Temp = ClassTemplate.mk_class("Temp", min=is_int, max=is_int, 
                                 inv=lambda self, args: 
								      args["min"] &lt;= args["max"])
</pre>

<p>
<code>Temp</code> is now a class with two state variables <code>min</code> and
<code>max</code>, both satisfying the type predicate <code>is_int</code> and
together satisfying the invariant <code>min</code> is less than equal
to <code>max</code>.  Since <code>inv</code> ends up being a method in <code>Temp</code>, its
needs to carry as its first argument an object <code>self</code>, even
though the invariant itself is defined on elements of the
dictionary <code>args</code>.
</p>
</div>


<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Implementation</h3>
<div class="outline-text-3" id="text-4-1">
<p>
A class is created with no fields.  It is then mk_classd
with <code>ClassTemplate.mk_class</code>, which takes a class and a
dictionary mapping state variable names to their type
checks.  The keywords may contain a field called 'inv' which
is mapped to an invariant predicate that returns true or false.
</p>

<div class="org-src-container">

<pre class="src src-python" id="class_ClassTemplate"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ClassTemplate</span>():

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">inv_true</span>(obj, args):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_init</span>(cls):
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">obj is an instance of cls</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">args is a dictionary</span>
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(obj, **args): 
            check_dict(args)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">match arg keys with state_vars list</span>
            check_pred(<span style="font-weight: bold;">lambda</span> a: <span style="font-weight: bold;">sorted</span>(a.keys()) == \
                           <span style="font-weight: bold;">sorted</span>(cls.sorted_state_vars))(args)

            <span style="font-weight: bold; font-style: italic;">obj.state</span> = {}
            
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">each arg should satisfy its typecheck </span>
            <span style="font-weight: bold;">for</span> key, value <span style="font-weight: bold;">in</span> args.iteritems():
                cls.state_var_type_checks[key](value)

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">invariant must be true on args</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">check_inv(cls.inv,cls)args)</span>
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> obj.inv(args):
                <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">TypeError</span>(<span style="font-style: italic;">"invariant for class %s violated for init args %s"</span> %(cls.<span style="font-weight: bold;">__name__</span>, args))

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">initialize the state</span>
            <span style="font-weight: bold;">for</span> key, value <span style="font-weight: bold;">in</span> args.iteritems():
                <span style="font-weight: bold; font-style: italic;">obj.state</span>[key] = value


            <span style="font-weight: bold;">if</span> cls.is_persistent:
                <span style="font-weight: bold;">setattr</span>(obj, <span style="font-style: italic;">'hide_id'</span>, {})

        <span style="font-weight: bold;">return</span> fn

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_setter</span>(cls):
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(obj, **args):
            <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">obj is the object whose variables are being set</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">args is a dictionary of new variable bindings</span>

            check_dict(args)
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(obj, <span style="font-style: italic;">'state'</span>):
                <span style="font-weight: bold; font-style: italic;">obj.state</span> = {}
            <span style="font-weight: bold; font-style: italic;">tmp</span> = obj.state.copy()
            
            <span style="font-weight: bold;">for</span> key, value <span style="font-weight: bold;">in</span> args.iteritems():
                <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">arg variables should be a subset of those in the formal spec</span>
                <span style="font-weight: bold;">if</span> key <span style="font-weight: bold;">in</span> cls.sorted_state_vars:
                    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">and they should pass the type checking</span>
                    cls.state_var_type_checks[key](value)
                    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">if so update tmp with the new bindings in args</span>
                    <span style="font-weight: bold; font-style: italic;">tmp</span>[key] = value
                <span style="font-weight: bold;">else</span>:
                    <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">TypeError</span>(<span style="font-style: italic;">"set: Invalid field name %s"</span> % key)  

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">now check the invariant on tmp</span>
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> obj.inv(tmp):
                <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">TypeError</span>(<span style="font-style: italic;">"invariant for class %s violated for init args %s"</span> % (cls.<span style="font-weight: bold;">__name__</span>, args))

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">now save the state</span>
            <span style="font-weight: bold; font-style: italic;">obj.state</span> = tmp

            <span style="font-weight: bold;">if</span> <span style="font-style: italic;">'save_handler'</span> <span style="font-weight: bold;">in</span> (cls.custom_handlers):
                cls.custom_handlers[<span style="font-style: italic;">'save_handler'</span>](obj, **args)

        <span style="font-weight: bold;">return</span> fn

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_eq</span>(cls, pred):
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(obj, other):
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">isinstance</span>(other, obj.__class__) <span style="font-weight: bold;">and</span> pred(obj, other)
        <span style="font-weight: bold;">return</span> fn

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_to_client</span>(cls):
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(obj, level=1):
            <span style="font-weight: bold; font-style: italic;">to_client_var</span> = {}
            <span style="font-weight: bold;">for</span> key <span style="font-weight: bold;">in</span> cls.sorted_state_vars:
                <span style="font-weight: bold; font-style: italic;">value</span> = obj.get(key)

                <span style="font-weight: bold;">if</span> is_instrumented_list(value) <span style="font-weight: bold;">or</span> is_list(value):    
                    <span style="font-weight: bold; font-style: italic;">to_client_var</span>[key] = []

                    <span style="font-weight: bold;">for</span> item <span style="font-weight: bold;">in</span> value:
                        <span style="font-weight: bold;">if</span> level &lt;= 2:
                            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(item, <span style="font-style: italic;">'to_client'</span>):
                                to_client_var[key].append(\
                                    item.to_client(level=level+1))
                            <span style="font-weight: bold;">else</span>:
                                to_client_var[key].append(value)
                        <span style="font-weight: bold;">else</span>:
                            to_client_var[key].append(<span style="font-style: italic;">"Not Printing"</span>)
                        
                <span style="font-weight: bold;">elif</span> <span style="font-weight: bold;">hasattr</span>(value, <span style="font-style: italic;">'to_client'</span>):
                    <span style="font-weight: bold; font-style: italic;">to_client_var</span>[key] = value.to_client(level=level+1)
                <span style="font-weight: bold;">else</span>:
                    <span style="font-weight: bold; font-style: italic;">to_client_var</span>[key] = value

            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(obj, <span style="font-style: italic;">"id"</span>):
                <span style="font-weight: bold; font-style: italic;">to_client_var</span>[<span style="font-style: italic;">"id"</span>] = <span style="font-weight: bold;">str</span>(obj.<span style="font-weight: bold;">id</span>)

            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(obj, <span style="font-style: italic;">"hide_id"</span>) <span style="font-weight: bold;">and</span> <span style="font-style: italic;">'id'</span> <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">getattr</span>(obj, <span style="font-style: italic;">"hide_id"</span>).keys():
                <span style="font-weight: bold; font-style: italic;">to_client_var</span>[<span style="font-style: italic;">"id"</span>] = <span style="font-weight: bold;">str</span>(<span style="font-weight: bold;">getattr</span>(obj, <span style="font-style: italic;">"hide_id"</span>)[<span style="font-style: italic;">"id"</span>])

            <span style="font-weight: bold;">return</span> to_client_var

        <span style="font-weight: bold;">return</span> fn

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_add_attributes</span>(cls):
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(**formals):
            
            check_dict(formals)

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">append the keys of the formals</span>
            <span style="font-weight: bold; font-style: italic;">cls.sorted_state_vars</span> += formals.keys()

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">create a dictionary of type preds  for the  state variables</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">{'min': is_int, 'max': is_int}</span>
            cls.state_var_type_preds.update(formals.copy())

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">{'min': check_int, 'max': check_int}</span>
            <span style="font-weight: bold; font-style: italic;">cls.state_var_type_checks</span> = \
            {k: check_pred(v) <span style="font-weight: bold;">for</span> k, v <span style="font-weight: bold;">in</span> cls.state_var_type_preds.items()}

        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">staticmethod</span>(fn)

    &lt;&lt;mk_getter&gt;&gt;

    <span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_class</span>(_name, **formals):
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">name is the name of the class to be created</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">formals is a dictionary of name, type_pred pairs</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">example of formals: </span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">{'min': is_int, </span>
        <span style="font-weight: bold; font-style: italic;">#  </span><span style="font-weight: bold; font-style: italic;">'max': is_int, </span>
        <span style="font-weight: bold; font-style: italic;">#  </span><span style="font-weight: bold; font-style: italic;">'inv': lambda self, args: args['min'] &lt;= args['max']}</span>
        
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">check if formals is a dictionary</span>
        <span style="font-weight: bold;">if</span> formals:
            check_dict(formals)

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">create a class with name</span>
        <span style="font-weight: bold; font-style: italic;">cls</span> = meta(_name)

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">set the invariant</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">if absent in formals, use default (inv_true)</span>
        <span style="font-weight: bold;">if</span> <span style="font-style: italic;">'inv'</span> <span style="font-weight: bold;">in</span> formals:
            <span style="font-weight: bold; font-style: italic;">cls.inv</span> = formals[<span style="font-style: italic;">'inv'</span>]
            <span style="font-weight: bold;">del</span> formals[<span style="font-style: italic;">'inv'</span>]
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">cls.inv</span> = ClassTemplate.inv_true

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">create sorted list of state variables</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">['max', 'min']</span>
        <span style="font-weight: bold; font-style: italic;">cls.sorted_state_vars</span> = []
        <span style="font-weight: bold; font-style: italic;">cls.sorted_state_vars</span> = <span style="font-weight: bold;">sorted</span>(formals.keys())

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">create a dictionary of type preds  for the  state variables</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">{'min': is_int, 'max': is_int}</span>
        <span style="font-weight: bold; font-style: italic;">cls.state_var_type_preds</span> = {}
        <span style="font-weight: bold; font-style: italic;">cls.state_var_type_checks</span> = {}
        <span style="font-weight: bold; font-style: italic;">cls.state_var_type_preds</span>=formals.copy()

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">{'min': check_int, 'max': check_int}</span>
        <span style="font-weight: bold; font-style: italic;">cls.state_var_type_checks</span> = \
        {k: check_pred(v) <span style="font-weight: bold;">for</span> k, v <span style="font-weight: bold;">in</span> cls.state_var_type_preds.items()}

        <span style="font-weight: bold; font-style: italic;">cls.add_attributes</span> = ClassTemplate.mk_add_attributes(cls)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">__init__</span>
        <span style="font-weight: bold; font-style: italic;">cls.__init__</span> = ClassTemplate.mk_init(cls)

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">eq</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">to be done</span>
<span style="font-weight: bold; font-style: italic;">#       </span><span style="font-weight: bold; font-style: italic;">cls.__eq__ = ClassTemplate.mk_eq(cls)</span>

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">get</span>
        <span style="font-weight: bold; font-style: italic;">cls.get</span> = ClassTemplate.mk_getter(cls)

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">set</span>
        cls.<span style="font-weight: bold;">set</span> = ClassTemplate.mk_setter(cls)

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">to_client</span>
        <span style="font-weight: bold; font-style: italic;">cls.to_client</span> = ClassTemplate.mk_to_client(cls)

        <span style="font-weight: bold; font-style: italic;">cls.custom_handlers</span> = {}
        <span style="font-weight: bold; font-style: italic;">cls.is_persistent</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
        <span style="font-weight: bold; font-style: italic;">cls.custom_handlers</span>[<span style="font-style: italic;">'persistence'</span>] = <span style="font-weight: bold; text-decoration: underline;">False</span>
        <span style="font-weight: bold;">return</span> cls
</pre>
</div>
</div>

<div id="outline-container-sec-4-1-1" class="outline-4">
<h4 id="sec-4-1-1"><span class="section-number-4">4.1.1</span> The getter function</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
Provides the mechanism to access the attributes of an object.  For a
persistence object, all the attributes when retrieved from sql database
using orm, the attributes are saved to a different location.  
</p>
<div class="org-src-container">

<pre class="src src-python" id="mk_getter"><span style="font-weight: bold; text-decoration: underline;">@staticmethod</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mk_getter</span>(cls):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">fn</span>(obj,k):
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">str</span>(k) <span style="font-weight: bold;">and</span> (k <span style="font-weight: bold;">in</span> cls.sorted_state_vars):
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(obj, <span style="font-style: italic;">'id'</span>) <span style="font-weight: bold;">and</span> <span style="font-weight: bold;">getattr</span>(obj, <span style="font-style: italic;">'id'</span>) <span style="font-weight: bold;">is</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold; text-decoration: underline;">None</span>:
                <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">getattr</span>(obj, k)
            <span style="font-weight: bold;">else</span>:
                <span style="font-weight: bold;">return</span> obj.state[k]
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">TypeError</span>(<span style="font-style: italic;">"get: Invalid key %s"</span> % k)

    <span style="font-weight: bold;">return</span> fn
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Tests</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-python" id="class_TestClassTemplate"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestClassTemplate</span>(TestCase):
    <span style="font-weight: bold; font-style: italic;">Foo</span> = ClassTemplate.mk_class(<span style="font-style: italic;">"Foo"</span>,  x=is_int, y=is_str)
    <span style="font-weight: bold; font-style: italic;">Foo.foo</span> = Foo(x=4, y=<span style="font-style: italic;">"hello"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">test_class_template_with_Foo</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">print</span> <span style="font-style: italic;">"test_class_template_with_Foo"</span>
        <span style="font-weight: bold; font-style: italic;">Foo</span> = TestClassTemplate.Foo

        <span style="font-weight: bold;">self</span>.assertEqual(Foo.foo.get(<span style="font-style: italic;">"x"</span>), 4, <span style="font-style: italic;">"foo.get(x)==4"</span>)
        <span style="font-weight: bold;">self</span>.assertEqual(Foo.foo.get(<span style="font-style: italic;">"y"</span>), <span style="font-style: italic;">"hello"</span>, <span style="font-style: italic;">"foo.get(y)==hello"</span>)

        Foo.foo.<span style="font-weight: bold;">set</span>(x=7)
        <span style="font-weight: bold;">self</span>.assertEqual(Foo.foo.get(<span style="font-style: italic;">"x"</span>), 7, <span style="font-style: italic;">"foo.get(x)==7"</span>)
        <span style="font-weight: bold;">self</span>.assertTrue(Foo.foo.inv({<span style="font-style: italic;">'x'</span>: Foo.foo.get(<span style="font-style: italic;">"x"</span>)}), <span style="font-style: italic;">"Foo.foo.inv"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">temp_inv</span>(obj, args):
        <span style="font-weight: bold;">return</span> args[<span style="font-style: italic;">"min"</span>] &lt;= args[<span style="font-style: italic;">"max"</span>]

    <span style="font-weight: bold; font-style: italic;">Temp</span> = ClassTemplate.mk_class(<span style="font-style: italic;">"Temp"</span>, <span style="font-weight: bold;">min</span>=is_int, <span style="font-weight: bold;">max</span>=is_int, inv=temp_inv)

    <span style="font-weight: bold; font-style: italic;">Temp.temp</span> = Temp(<span style="font-weight: bold;">min</span>=4, <span style="font-weight: bold;">max</span>=5)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">eq_fn</span>(<span style="font-weight: bold;">self</span>, other):
        <span style="font-weight: bold;">return</span> \
            <span style="font-weight: bold;">isinstance</span>(other, <span style="font-weight: bold;">self</span>.__class__) <span style="font-weight: bold;">and</span> \
            <span style="font-weight: bold;">self</span>.get(<span style="font-style: italic;">"min"</span>) == other.get(<span style="font-style: italic;">"min"</span>) <span style="font-weight: bold;">and</span> \
            <span style="font-weight: bold;">self</span>.get(<span style="font-style: italic;">"max"</span>) == other.get(<span style="font-style: italic;">"max"</span>)

    <span style="font-weight: bold; font-style: italic;">Temp.__eq__</span> = eq_fn

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">test_class_template_with_Temp</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">print</span> <span style="font-style: italic;">"test_class_template_with_Temp"</span>
        <span style="font-weight: bold; font-style: italic;">Temp</span> = TestClassTemplate.Temp
        <span style="font-weight: bold;">self</span>.assertEqual(Temp.temp.get(<span style="font-style: italic;">"min"</span>), 4, <span style="font-style: italic;">"temp.get(min)==4"</span>)
        <span style="font-weight: bold;">self</span>.assertEqual(Temp.temp.get(<span style="font-style: italic;">"max"</span>), 5, <span style="font-style: italic;">"temp.get(max)==5"</span>)

        Temp.temp.<span style="font-weight: bold;">set</span>(<span style="font-weight: bold;">min</span>=0)
        <span style="font-weight: bold;">self</span>.assertEqual(Temp.temp.get(<span style="font-style: italic;">"min"</span>), 0, <span style="font-style: italic;">"temp.get(min)==0"</span>)
        <span style="font-weight: bold;">self</span>.assertRaises(<span style="font-weight: bold; text-decoration: underline;">TypeError</span>, <span style="font-weight: bold;">lambda</span>: Temp.temp.<span style="font-weight: bold;">set</span>(<span style="font-weight: bold;">min</span>=9),
                          <span style="font-style: italic;">"temp.set(min=9) Error"</span>)

        <span style="font-weight: bold; font-style: italic;">temp2</span> = Temp(<span style="font-weight: bold;">min</span>=0, <span style="font-weight: bold;">max</span>=5)

        <span style="font-weight: bold;">self</span>.assertTrue(Temp.temp == temp2, <span style="font-style: italic;">"temp==temp2"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">test_class_template_with_many_objects</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">print</span> <span style="font-style: italic;">"test_class_template_with_many_objects"</span>
        <span style="font-weight: bold; font-style: italic;">Name</span> = ClassTemplate.mk_class(<span style="font-style: italic;">"Name"</span>, name=is_alphabetic_str)
        <span style="font-weight: bold; font-style: italic;">name</span> = Name(name=<span style="font-style: italic;">"Jimi Hendrix"</span>)
        <span style="font-weight: bold; font-style: italic;">Email</span> = ClassTemplate.mk_class(<span style="font-style: italic;">"Email"</span>, email=is_email_str)
        <span style="font-weight: bold; font-style: italic;">email</span> = Email(email=<span style="font-style: italic;">"jimi@gnu.org"</span>)
        <span style="font-weight: bold; font-style: italic;">User</span> = ClassTemplate.mk_class(<span style="font-style: italic;">"User"</span>,
                                       name=is_inst(Name),
                                       email=is_inst(Email))
        <span style="font-weight: bold; font-style: italic;">usr</span> = User(name=name, email=email)
        <span style="font-weight: bold;">self</span>.assertEqual(usr.get(<span style="font-style: italic;">'name'</span>).get(<span style="font-style: italic;">'name'</span>), <span style="font-style: italic;">'Jimi Hendrix'</span>)
        <span style="font-weight: bold;">self</span>.assertEqual(usr.get(<span style="font-style: italic;">'email'</span>).get(<span style="font-style: italic;">'email'</span>), <span style="font-style: italic;">'jimi@gnu.org'</span>)
        <span style="font-weight: bold;">self</span>.assertEqual(usr.to_client()[<span style="font-style: italic;">'email'</span>][<span style="font-style: italic;">'email'</span>], <span style="font-style: italic;">'jimi@gnu.org'</span>)
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: VLEAD</p>
<p class="date">Created: 2017-04-26 Wed 22:27</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
